@page
@model SkillsModel
@{
    ViewData["Title"] = "技能管理";
    ViewData["ActivePage"] = "Skills";
}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-0">技能管理</h4>
        <small class="text-muted">技能列表、给予技能、修改技能属性</small>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-magic"></i> 给予技能 <span class="badge bg-warning text-dark">需要 Admin 权限</span>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="GiveSkill">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">玩家名称</label>
                            <input type="text" class="form-control" name="playerName" id="giveSkillPlayerName" placeholder="在线玩家角色名" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">技能 ID</label>
                            <input type="number" class="form-control" name="magicIndex" id="giveSkillMagicIndex" placeholder="技能索引" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">等级</label>
                            <input type="number" class="form-control" name="level" value="1" min="0" max="6">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle"></i> 给予
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-stars"></i> 全职业技能 <span class="badge bg-warning text-dark">需要 SuperAdmin 权限</span>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="GiveAllSkills" onsubmit="return confirm('确定要给该玩家添加所有职业技能吗？')">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">玩家名称</label>
                            <input type="text" class="form-control" name="playerName" placeholder="在线玩家角色名" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">技能等级</label>
                            <input type="number" class="form-control" name="level" value="3" min="0" max="6">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-lightning-fill"></i> 全技能
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">给玩家添加其职业的所有技能</small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Remove Skill -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-trash"></i> 移除技能 <span class="badge bg-danger">需要 Admin 权限</span>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="RemoveSkill" onsubmit="return confirm('确定要移除该玩家的技能吗？')">
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">玩家名称</label>
                    <input type="text" class="form-control" name="playerName" placeholder="在线玩家角色名" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">技能 ID</label>
                    <input type="number" class="form-control" name="magicIndex" id="removeSkillMagicIndex" placeholder="要移除的技能索引" min="0" required>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-x-circle"></i> 移除技能
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Custom Summon Skills Management -->
<div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-stars"></i> 自定义召唤技能 <span class="badge bg-warning text-dark">需要 SuperAdmin 权限</span></span>
        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createCustomSummonModal">
            <i class="bi bi-plus-circle"></i> 创建召唤技能
        </button>
    </div>
    <div class="card-body">
        @if (Model.CustomSummonSkills.Count == 0)
        {
            <div class="text-center text-muted py-3">
                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                暂无自定义召唤技能，点击"创建召唤技能"按钮创建
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>召唤怪物</th>
                            <th>数量上限</th>
                            <th>护符消耗</th>
                            <th>学派</th>
                            <th>职业</th>
                            <th>学习等级</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var skill in Model.CustomSummonSkills)
                        {
                            <tr>
                                <td><code>@skill.Index</code></td>
                                <td><strong>@skill.Name</strong></td>
                                <td>
                                    <span class="badge bg-info">[@skill.SummonMonsterIndex]</span>
                                    @skill.MonsterName
                                </td>
                                <td><span class="badge bg-primary">@skill.MaxSummonCount</span></td>
                                <td><span class="badge bg-secondary">@skill.AmuletCost</span></td>
                                <td>
                                    @switch (skill.School)
                                    {
                                        case "Fire":
                                            <span class="badge bg-danger">火</span>
                                            break;
                                        case "Ice":
                                            <span class="badge bg-info">冰</span>
                                            break;
                                        case "Lightning":
                                            <span class="badge bg-warning text-dark">雷</span>
                                            break;
                                        case "Wind":
                                            <span class="badge bg-success">风</span>
                                            break;
                                        case "Holy":
                                            <span class="badge bg-light text-dark">神圣</span>
                                            break;
                                        case "Dark":
                                            <span class="badge bg-dark">暗黑</span>
                                            break;
                                        case "Phantom":
                                            <span class="badge bg-purple" style="background-color: #6f42c1 !important;">幻影</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">无</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    @switch (skill.Class)
                                    {
                                        case "Warrior":
                                            <span class="badge bg-danger">战士</span>
                                            break;
                                        case "Wizard":
                                            <span class="badge bg-primary">法师</span>
                                            break;
                                        case "Taoist":
                                            <span class="badge bg-success">道士</span>
                                            break;
                                        case "Assassin":
                                            <span class="badge bg-dark">刺客</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@skill.Class</span>
                                            break;
                                    }
                                </td>
                                <td>@skill.NeedLevel1</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary"
                                                onclick="editCustomSummon(@skill.Index, '@skill.Name', @skill.SummonMonsterIndex, @skill.MaxSummonCount, @skill.AmuletCost, '@skill.Class', @skill.NeedLevel1, '@skill.Description', '@skill.School')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="deleteCustomSummon(@skill.Index, '@skill.Name')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Search & Filter -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-search"></i> 搜索筛选
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">关键字</label>
                <input type="text" class="form-control" name="Keyword" value="@Model.Keyword" placeholder="技能名称/ID">
            </div>
            <div class="col-md-3">
                <label class="form-label">职业</label>
                <select class="form-select" name="ClassFilter">
                    <option value="">全部职业</option>
                    <option value="Warrior" selected="@(Model.ClassFilter == "Warrior")">战士</option>
                    <option value="Wizard" selected="@(Model.ClassFilter == "Wizard")">法师</option>
                    <option value="Taoist" selected="@(Model.ClassFilter == "Taoist")">道士</option>
                    <option value="Assassin" selected="@(Model.ClassFilter == "Assassin")">刺客</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">类型</label>
                <select class="form-select" name="SchoolFilter">
                    <option value="">全部类型</option>
                    <option value="None" selected="@(Model.SchoolFilter == "None")">无</option>
                    <option value="Combat" selected="@(Model.SchoolFilter == "Combat")">战斗</option>
                    <option value="Elemental" selected="@(Model.SchoolFilter == "Elemental")">元素</option>
                    <option value="Spirit" selected="@(Model.SchoolFilter == "Spirit")">灵魂</option>
                    <option value="Nature" selected="@(Model.SchoolFilter == "Nature")">自然</option>
                    <option value="Passive" selected="@(Model.SchoolFilter == "Passive")">被动</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <a href="/Skills" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Skills List -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list"></i> 技能列表</span>
        <span class="badge bg-secondary">共 @Model.TotalCount 个技能</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 50px;">图标</th>
                        <th>名称</th>
                        <th>技能类型</th>
                        <th>职业</th>
                        <th>学派</th>
                        <th>基础威力</th>
                        <th>等级威力</th>
                        <th>消耗</th>
                        <th>学习等级</th>
                        <th>冷却</th>
                        <th style="width: 120px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Magics.Count == 0)
                    {
                        <tr>
                            <td colspan="12" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                没有找到技能数据
                            </td>
                        </tr>
                    }
                    @foreach (var magic in Model.Magics)
                    {
                        <tr>
                            <td><code>@magic.Index</code></td>
                            <td>
                                <span class="badge bg-secondary">@magic.Icon</span>
                            </td>
                            <td>
                                <strong>@magic.Name</strong>
                                <br><small class="text-muted">@magic.Magic</small>
                            </td>
                            <td><span class="badge bg-info">@magic.Mode</span></td>
                            <td>
                                @switch (magic.Class)
                                {
                                    case "Warrior":
                                        <span class="badge bg-danger">战士</span>
                                        break;
                                    case "Wizard":
                                        <span class="badge bg-primary">法师</span>
                                        break;
                                    case "Taoist":
                                        <span class="badge bg-success">道士</span>
                                        break;
                                    case "Assassin":
                                        <span class="badge bg-dark">刺客</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary">@magic.Class</span>
                                        break;
                                }
                            </td>
                            <td><span class="badge bg-secondary">@magic.School</span></td>
                            <td>
                                <small>@magic.MinBasePower - @magic.MaxBasePower</small>
                            </td>
                            <td>
                                <small>@magic.MinLevelPower - @magic.MaxLevelPower</small>
                            </td>
                            <td>
                                <small>@magic.BaseCost + @magic.LevelCost/级</small>
                            </td>
                            <td>
                                <small>@magic.NeedLevel1/@magic.NeedLevel2/@magic.NeedLevel3</small>
                            </td>
                            <td>
                                <small>@magic.Delay ms</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success"
                                            onclick="fillSkillMagic(@magic.Index)"
                                            title="填入技能ID">
                                        <i class="bi bi-gift"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            data-index="@magic.Index"
                                            data-name="@magic.Name"
                                            data-icon="@magic.Icon"
                                            data-minbasepower="@magic.MinBasePower"
                                            data-maxbasepower="@magic.MaxBasePower"
                                            data-minlevelpower="@magic.MinLevelPower"
                                            data-maxlevelpower="@magic.MaxLevelPower"
                                            data-basecost="@magic.BaseCost"
                                            data-levelcost="@magic.LevelCost"
                                            data-needlevel1="@magic.NeedLevel1"
                                            data-needlevel2="@magic.NeedLevel2"
                                            data-needlevel3="@magic.NeedLevel3"
                                            data-experience1="@magic.Experience1"
                                            data-experience2="@magic.Experience2"
                                            data-experience3="@magic.Experience3"
                                            data-delay="@magic.Delay"
                                            data-description="@magic.Description">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (Model.TotalPages > 1)
    {
        <div class="card-footer">
            <nav>
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Skills?CurrentPage=@(Model.CurrentPage - 1)&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    }
                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="/Skills?CurrentPage=@i&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">@i</a>
                        </li>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Skills?CurrentPage=@(Model.CurrentPage + 1)&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateMagic">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑技能属性</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 需要 <strong>SuperAdmin</strong> 权限才能修改技能属性
                    </div>
                    <input type="hidden" name="index" id="edit-index">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">技能名称</label>
                            <input type="text" class="form-control" name="name" id="edit-name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">图标 ID</label>
                            <input type="number" class="form-control" name="icon" id="edit-icon" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小基础威力</label>
                            <input type="number" class="form-control" name="minBasePower" id="edit-minbasepower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大基础威力</label>
                            <input type="number" class="form-control" name="maxBasePower" id="edit-maxbasepower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小等级威力</label>
                            <input type="number" class="form-control" name="minLevelPower" id="edit-minlevelpower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大等级威力</label>
                            <input type="number" class="form-control" name="maxLevelPower" id="edit-maxlevelpower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">基础消耗</label>
                            <input type="number" class="form-control" name="baseCost" id="edit-basecost" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">等级消耗</label>
                            <input type="number" class="form-control" name="levelCost" id="edit-levelcost" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">冷却(ms)</label>
                            <input type="number" class="form-control" name="delay" id="edit-delay" min="0" max="9999999">
                        </div>
                        <div class="col-md-3"></div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 1</label>
                            <input type="number" class="form-control" name="needLevel1" id="edit-needlevel1" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 2</label>
                            <input type="number" class="form-control" name="needLevel2" id="edit-needlevel2" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 3</label>
                            <input type="number" class="form-control" name="needLevel3" id="edit-needlevel3" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 1</label>
                            <input type="number" class="form-control" name="experience1" id="edit-experience1" min="0" max="9999999">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 2</label>
                            <input type="number" class="form-control" name="experience2" id="edit-experience2" min="0" max="9999999">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 3</label>
                            <input type="number" class="form-control" name="experience3" id="edit-experience3" min="0" max="9999999">
                        </div>
                        <div class="col-12">
                            <label class="form-label">技能描述</label>
                            <textarea class="form-control" name="description" id="edit-description" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Custom Summon Modal -->
<div class="modal fade" id="createCustomSummonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateCustomSummon" id="createCustomSummonForm">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-stars"></i> 创建自定义召唤技能</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">技能名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" id="customSummon-name" placeholder="如：召唤火龙" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">职业 <span class="text-danger">*</span></label>
                            <select class="form-select" name="mirClass" id="customSummon-class" required>
                                <option value="Taoist">道士</option>
                                <option value="Wizard">法师</option>
                                <option value="Warrior">战士</option>
                                <option value="Assassin">刺客</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">召唤怪物 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control mb-2" id="monsterSearchInput" placeholder="输入怪物名称或ID搜索...">
                            <select class="form-select" name="monsterIndex" id="customSummon-monster" size="6" required>
                                @foreach (var monster in Model.MonsterList)
                                {
                                    <option value="@monster.Index">[@monster.Index] @monster.MonsterName (Lv.@monster.Level)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">数量上限</label>
                            <input type="number" class="form-control" name="maxCount" id="customSummon-maxCount" value="2" min="1">
                            <small class="text-muted">可同时召唤的最大数量</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">护身符消耗</label>
                            <input type="number" class="form-control" name="amuletCost" id="customSummon-amuletCost" value="1" min="1">
                            <small class="text-muted">每次召唤消耗的护身符数</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级</label>
                            <input type="number" class="form-control" name="needLevel" id="customSummon-needLevel" value="1" min="1" max="255">
                            <small class="text-muted">学习技能所需等级</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">元素学派</label>
                            <select class="form-select" name="school" id="customSummon-school">
                                <option value="None">无</option>
                                <option value="Fire">火</option>
                                <option value="Ice">冰</option>
                                <option value="Lightning">雷</option>
                                <option value="Wind">风</option>
                                <option value="Holy">神圣</option>
                                <option value="Dark">暗黑</option>
                                <option value="Phantom">幻影</option>
                            </select>
                            <small class="text-muted">影响召唤宠物的元素加成</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">技能描述</label>
                            <textarea class="form-control" name="description" id="customSummon-description" rows="2" placeholder="召唤一只强大的宝宝为你战斗..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> 创建
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Custom Summon Modal -->
<div class="modal fade" id="editCustomSummonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateCustomSummon" id="editCustomSummonForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑自定义召唤技能</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="magicIndex" id="editCustomSummon-index">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">技能名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" id="editCustomSummon-name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">职业</label>
                            <input type="text" class="form-control" id="editCustomSummon-classDisplay" disabled>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">召唤怪物 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control mb-2" id="editMonsterSearchInput" placeholder="输入怪物名称或ID搜索...">
                            <select class="form-select" name="monsterIndex" id="editCustomSummon-monster" size="6" required>
                                @foreach (var monster in Model.MonsterList)
                                {
                                    <option value="@monster.Index">[@monster.Index] @monster.MonsterName (Lv.@monster.Level)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">数量上限</label>
                            <input type="number" class="form-control" name="maxCount" id="editCustomSummon-maxCount" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">护身符消耗</label>
                            <input type="number" class="form-control" name="amuletCost" id="editCustomSummon-amuletCost" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级</label>
                            <input type="number" class="form-control" name="needLevel" id="editCustomSummon-needLevel" min="1" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">元素学派</label>
                            <select class="form-select" name="school" id="editCustomSummon-school">
                                <option value="None">无</option>
                                <option value="Fire">火</option>
                                <option value="Ice">冰</option>
                                <option value="Lightning">雷</option>
                                <option value="Wind">风</option>
                                <option value="Holy">神圣</option>
                                <option value="Dark">暗黑</option>
                                <option value="Phantom">幻影</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">技能描述</label>
                            <textarea class="form-control" name="description" id="editCustomSummon-description" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Custom Summon Form (Hidden) -->
<form method="post" asp-page-handler="DeleteCustomSummon" id="deleteCustomSummonForm" style="display: none;">
    <input type="hidden" name="magicIndex" id="deleteCustomSummon-index">
</form>

@section Scripts {
    <script>
        // AJAX表单绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 给予技能表单
            const giveSkillForm = document.querySelector('form[asp-page-handler="GiveSkill"]');
            if (giveSkillForm) {
                AjaxForm.bindOne(giveSkillForm, {
                    successMessage: '技能已成功给予玩家',
                    resetForm: true
                });
            }

            // 全职业技能表单
            const giveAllForm = document.querySelector('form[asp-page-handler="GiveAllSkills"]');
            if (giveAllForm) {
                giveAllForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要给该玩家添加所有职业技能吗?')) {
                        AjaxForm.submit(giveAllForm, {
                            successMessage: '所有职业技能已成功给予玩家',
                            resetForm: true
                        });
                    }
                });
            }

            // 移除技能表单
            const removeSkillForm = document.querySelector('form[asp-page-handler="RemoveSkill"]');
            if (removeSkillForm) {
                removeSkillForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要移除该玩家的技能吗?')) {
                        AjaxForm.submit(removeSkillForm, {
                            successMessage: '技能已成功移除',
                            resetForm: true
                        });
                    }
                });
            }

            // 编辑技能模态框表单
            const editMagicForm = document.querySelector('form[asp-page-handler="UpdateMagic"]');
            if (editMagicForm) {
                AjaxForm.bindOne(editMagicForm, {
                    successMessage: '技能属性已保存',
                    closeModal: true,
                    modalId: 'editModal'
                });
            }
        });

        // 填充技能ID到给予/移除表单
        function fillSkillMagic(magicIndex) {
            const giveInput = document.getElementById('giveSkillMagicIndex');
            if (giveInput) giveInput.value = magicIndex;

            const removeInput = document.getElementById('removeSkillMagicIndex');
            if (removeInput) removeInput.value = magicIndex;

            const playerInput = document.getElementById('giveSkillPlayerName');
            if (playerInput) playerInput.focus();
        }

        // Edit modal data binding
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('edit-index').value = button.getAttribute('data-index');
            document.getElementById('edit-name').value = button.getAttribute('data-name');
            document.getElementById('edit-icon').value = button.getAttribute('data-icon');
            document.getElementById('edit-minbasepower').value = button.getAttribute('data-minbasepower');
            document.getElementById('edit-maxbasepower').value = button.getAttribute('data-maxbasepower');
            document.getElementById('edit-minlevelpower').value = button.getAttribute('data-minlevelpower');
            document.getElementById('edit-maxlevelpower').value = button.getAttribute('data-maxlevelpower');
            document.getElementById('edit-basecost').value = button.getAttribute('data-basecost');
            document.getElementById('edit-levelcost').value = button.getAttribute('data-levelcost');
            document.getElementById('edit-needlevel1').value = button.getAttribute('data-needlevel1');
            document.getElementById('edit-needlevel2').value = button.getAttribute('data-needlevel2');
            document.getElementById('edit-needlevel3').value = button.getAttribute('data-needlevel3');
            document.getElementById('edit-experience1').value = button.getAttribute('data-experience1');
            document.getElementById('edit-experience2').value = button.getAttribute('data-experience2');
            document.getElementById('edit-experience3').value = button.getAttribute('data-experience3');
            document.getElementById('edit-delay').value = button.getAttribute('data-delay');
            document.getElementById('edit-description').value = button.getAttribute('data-description') || '';
        });

        // ========== 自定义召唤技能相关函数 ==========

        // 初始化怪物搜索功能
        function initMonsterSearch(searchInputId, selectId) {
            const searchInput = document.getElementById(searchInputId);
            const select = document.getElementById(selectId);
            if (!searchInput || !select) return;

            const options = Array.from(select.options);

            searchInput.addEventListener('input', function() {
                const filter = this.value.toLowerCase();
                options.forEach(option => {
                    const text = option.text.toLowerCase();
                    option.style.display = text.includes(filter) ? '' : 'none';
                });
            });
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化怪物搜索
            initMonsterSearch('monsterSearchInput', 'customSummon-monster');
            initMonsterSearch('editMonsterSearchInput', 'editCustomSummon-monster');

            // 创建自定义召唤技能表单
            const createCustomSummonForm = document.getElementById('createCustomSummonForm');
            if (createCustomSummonForm) {
                AjaxForm.bindOne(createCustomSummonForm, {
                    successMessage: '自定义召唤技能创建成功',
                    closeModal: true,
                    modalId: 'createCustomSummonModal',
                    onSuccess: function() {
                        setTimeout(function() { location.reload(); }, 1500);
                    }
                });
            }

            // 编辑自定义召唤技能表单
            const editCustomSummonForm = document.getElementById('editCustomSummonForm');
            if (editCustomSummonForm) {
                AjaxForm.bindOne(editCustomSummonForm, {
                    successMessage: '自定义召唤技能已更新',
                    closeModal: true,
                    modalId: 'editCustomSummonModal',
                    onSuccess: function() {
                        setTimeout(function() { location.reload(); }, 1500);
                    }
                });
            }

            // 删除自定义召唤技能表单
            const deleteCustomSummonForm = document.getElementById('deleteCustomSummonForm');
            if (deleteCustomSummonForm) {
                AjaxForm.bindOne(deleteCustomSummonForm, {
                    successMessage: '自定义召唤技能已删除',
                    onSuccess: function() {
                        setTimeout(function() { location.reload(); }, 1500);
                    }
                });
            }
        });

        // 编辑自定义召唤技能
        function editCustomSummon(index, name, monsterIndex, maxCount, amuletCost, mirClass, needLevel, description, school) {
            document.getElementById('editCustomSummon-index').value = index;
            document.getElementById('editCustomSummon-name').value = name;
            document.getElementById('editCustomSummon-monster').value = monsterIndex;
            document.getElementById('editCustomSummon-maxCount').value = maxCount;
            document.getElementById('editCustomSummon-amuletCost').value = amuletCost;
            document.getElementById('editCustomSummon-classDisplay').value = getClassDisplayName(mirClass);
            document.getElementById('editCustomSummon-needLevel').value = needLevel;
            document.getElementById('editCustomSummon-description').value = description || '';
            document.getElementById('editCustomSummon-school').value = school || 'None';

            var modal = new bootstrap.Modal(document.getElementById('editCustomSummonModal'));
            modal.show();
        }

        // 删除自定义召唤技能
        function deleteCustomSummon(index, name) {
            if (confirm('确定要删除召唤技能 [' + name + '] 吗？此操作不可恢复！')) {
                document.getElementById('deleteCustomSummon-index').value = index;
                AjaxForm.submit(document.getElementById('deleteCustomSummonForm'), {
                    successMessage: '自定义召唤技能已删除'
                });
            }
        }

        // 获取职业显示名称
        function getClassDisplayName(mirClass) {
            switch (mirClass) {
                case 'Warrior': return '战士';
                case 'Wizard': return '法师';
                case 'Taoist': return '道士';
                case 'Assassin': return '刺客';
                default: return mirClass;
            }
        }
    </script>
}
